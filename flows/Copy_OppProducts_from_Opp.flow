<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>CreateNewOppProductsFault</name>
        <label>CreateNewOppProductsFault</label>
        <locationX>311</locationX>
        <locationY>682</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>CreateNewOppProductsFault</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <stringValue>mike@curioushuman.com.au</stringValue>
            </value>
        </inputParameters>
    </actionCalls>
    <actionCalls>
        <name>FindPreviousOppProductsFault</name>
        <label>FindPreviousOppProductsFault</label>
        <locationX>308</locationX>
        <locationY>46</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>FindPreviousOppProductsFault</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <stringValue>mike@curioushuman.com.au</stringValue>
            </value>
        </inputParameters>
    </actionCalls>
    <actionCalls>
        <name>LookupPricebookEntryFault</name>
        <label>LookupPricebookEntryFault</label>
        <locationX>927</locationX>
        <locationY>146</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>Fault lookup pricebook entry</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <stringValue>mike@curioushuman.com.au</stringValue>
            </value>
        </inputParameters>
    </actionCalls>
    <actionCalls>
        <name>ResolveMissingProducts</name>
        <label>ResolveMissingProducts</label>
        <locationX>73</locationX>
        <locationY>405</locationY>
        <actionName>New_Task</actionName>
        <actionType>quickAction</actionType>
        <connector>
            <targetReference>OppProducts_to_create</targetReference>
        </connector>
        <inputParameters>
            <name>OwnerId</name>
            <value>
                <elementReference>vUserId</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>Description</name>
            <value>
                <stringValue>The following products are missing. Please add the correct version mannually, and consider updating your template with both Australian and International versions of this product. {!vMissingProducts}</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>Subject</name>
            <value>
                <stringValue>Products found missing during copy</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>ActivityDate</name>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>Status</name>
            <value>
                <stringValue>Not Started</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>Priority</name>
            <value>
                <stringValue>Normal</stringValue>
            </value>
        </inputParameters>
    </actionCalls>
    <assignments>
        <name>Add_NewOppProduct_to_collection</name>
        <label>Add NewOppProduct to collection</label>
        <locationX>718</locationX>
        <locationY>542</locationY>
        <assignmentItems>
            <assignToReference>sNewOppProducts</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>sNewOppProduct</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Foreach_PrevOppProduct</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>RecordProductMissing</name>
        <label>RecordProductMissing</label>
        <locationX>476</locationX>
        <locationY>203</locationY>
        <assignmentItems>
            <assignToReference>vMissingProducts</assignToReference>
            <operator>Add</operator>
            <value>
                <stringValue>{!sPrevOppProduct.Product_name__c},</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Foreach_PrevOppProduct</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_NewOppProduct</name>
        <label>Set NewOppProduct</label>
        <locationX>718</locationX>
        <locationY>411</locationY>
        <assignmentItems>
            <assignToReference>sNewOppProduct.OpportunityId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>vOpportunityId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>sNewOppProduct.PricebookEntryId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>sPriceBookEntry.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>sNewOppProduct.UnitPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>sPriceBookEntry.UnitPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>sNewOppProduct.ListPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>sPriceBookEntry.UnitPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>sNewOppProduct.Quantity</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_NewOppProduct_to_collection</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>AnyMissingProducts</name>
        <label>AnyMissingProducts</label>
        <locationX>313</locationX>
        <locationY>277</locationY>
        <defaultConnector>
            <targetReference>ResolveMissingProducts</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>MissingProducts</defaultConnectorLabel>
        <rules>
            <name>NoMissingProducts</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>vMissingProducts</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Missing products:</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>OppProducts_to_create</targetReference>
            </connector>
            <label>NoMissingProducts</label>
        </rules>
    </decisions>
    <decisions>
        <name>OppProducts_exist</name>
        <label>OppProducts exist</label>
        <locationX>125</locationX>
        <locationY>150</locationY>
        <defaultConnectorLabel>[Default Outcome]</defaultConnectorLabel>
        <rules>
            <name>Do_exist</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>sPrevOppProducts</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Foreach_PrevOppProduct</targetReference>
            </connector>
            <label>Do exist</label>
        </rules>
    </decisions>
    <decisions>
        <name>OppProducts_to_create</name>
        <label>OppProducts to create?</label>
        <locationX>308</locationX>
        <locationY>407</locationY>
        <defaultConnectorLabel>No OppProducts to create</defaultConnectorLabel>
        <rules>
            <name>OppProducts_exist_to_create</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>sNewOppProducts</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_NewOppProducts</targetReference>
            </connector>
            <label>OppProducts exist to create</label>
        </rules>
    </decisions>
    <decisions>
        <name>PriceBookEntry_exists</name>
        <label>PriceBookEntry exists</label>
        <locationX>719</locationX>
        <locationY>263</locationY>
        <defaultConnector>
            <targetReference>RecordProductMissing</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Doesn&apos;t exist</defaultConnectorLabel>
        <rules>
            <name>Does_exist</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>sPriceBookEntry.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_NewOppProduct</targetReference>
            </connector>
            <label>Does exist</label>
        </rules>
    </decisions>
    <interviewLabel>Copy OppProducts from Opp {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Copy OppProducts from Opp</label>
    <loops>
        <name>Foreach_PrevOppProduct</name>
        <label>Foreach PrevOppProduct</label>
        <locationX>314</locationX>
        <locationY>146</locationY>
        <assignNextValueToReference>sPrevOppProduct</assignNextValueToReference>
        <collectionReference>sPrevOppProducts</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Find_PriceBookEntry</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>AnyMissingProducts</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_NewOppProducts</name>
        <label>Create NewOppProducts</label>
        <locationX>310</locationX>
        <locationY>539</locationY>
        <faultConnector>
            <targetReference>CreateNewOppProductsFault</targetReference>
        </faultConnector>
        <inputReference>sNewOppProducts</inputReference>
    </recordCreates>
    <recordLookups>
        <name>Find_previous_OppProducts</name>
        <label>Find previous OppProducts</label>
        <locationX>126</locationX>
        <locationY>48</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>OppProducts_exist</targetReference>
        </connector>
        <faultConnector>
            <targetReference>FindPreviousOppProductsFault</targetReference>
        </faultConnector>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vPrevOpportunityId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Product_Type__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Expense</stringValue>
            </value>
        </filters>
        <object>OpportunityLineItem</object>
        <outputReference>sPrevOppProducts</outputReference>
        <queriedFields>OpportunityId</queriedFields>
        <queriedFields>Product2Id</queriedFields>
        <queriedFields>Product_name__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Find_PriceBookEntry</name>
        <label>Find PriceBookEntry</label>
        <locationX>719</locationX>
        <locationY>150</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>PriceBookEntry_exists</targetReference>
        </connector>
        <faultConnector>
            <targetReference>LookupPricebookEntryFault</targetReference>
        </faultConnector>
        <filters>
            <field>Pricebook2Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>vPriceBookId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Product2Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>sPrevOppProduct.Product2Id</elementReference>
            </value>
        </filters>
        <object>PricebookEntry</object>
        <outputAssignments>
            <assignToReference>sPriceBookEntry.Id</assignToReference>
            <field>Id</field>
        </outputAssignments>
        <outputAssignments>
            <assignToReference>sPriceBookEntry.UnitPrice</assignToReference>
            <field>UnitPrice</field>
        </outputAssignments>
    </recordLookups>
    <startElementReference>Find_previous_OppProducts</startElementReference>
    <status>Active</status>
    <variables>
        <name>sNewOppProduct</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>sNewOppProducts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>sPrevOppProduct</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>sPrevOppProducts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>sPriceBookEntry</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>PricebookEntry</objectType>
    </variables>
    <variables>
        <name>vMissingProducts</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <value>
            <stringValue>Missing products:</stringValue>
        </value>
    </variables>
    <variables>
        <name>vOpportunityId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>vPrevOpportunityId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>vPriceBookId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>vUserId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
</Flow>
